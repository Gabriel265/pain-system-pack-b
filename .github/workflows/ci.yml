name: AI-Lab CI (Lint + Build + Deps Gate)

on:
  push:
    branches: [ai-lab]
  pull_request:
    branches: [ai-deploy]

jobs:
  deps-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed for git ls-files check

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Enforce dependency allowlist + pinned versions + lockfile
        run: |
          # ─────────────────────────────────────────────────────────────
          # 1. Allowlist check
          node -e '
            const fs = require("fs");
            const allowed = new Set(JSON.parse(fs.readFileSync(".github/allowed-dependencies.json", "utf-8")).allowed);
            
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf-8"));
            
            const allDeps = {
              ...pkg.dependencies    || {},
              ...pkg.devDependencies || {},
              ...pkg.peerDependencies|| {},
              ...pkg.optionalDependencies || {}
            };

            const violations = Object.keys(allDeps)
              .filter(name => !allowed.has(name))
              .map(name => `${name}@${allDeps[name]}`);

            if (violations.length > 0) {
              console.error("Forbidden dependencies detected:");
              violations.forEach(v => console.error("  • " + v));
              console.error("\nOnly dependencies from the strict allowlist are permitted on ai-lab branch.");
              process.exit(1);
            }
          '

          # ─────────────────────────────────────────────────────────────
          # 2. Pinned versions only (no ^ ~ >= <= etc.)
          if grep -qE '"[^"]+":\s*"[^"]*[ ^~><=][^"]*"' package.json; then
            echo ""
            echo "Error: All dependencies must use **exact** versions (no ^ ~ >= <= etc)."
            echo "Found non-pinned version ranges:"
            grep -E '"[^"]+":\s*"[^"]*[ ^~><=][^"]*"' package.json || true
            echo ""
            exit 1
          fi

          # ─────────────────────────────────────────────────────────────
          # 3. package-lock.json must exist and be tracked
          if [[ ! -f package-lock.json ]]; then
            echo "package-lock.json is required (run 'npm install' locally and commit it)"
            exit 1
          fi

          if ! git ls-files --error-unmatch package-lock.json >/dev/null 2>&1; then
            echo "package-lock.json must be committed (not gitignored)"
            exit 1
          fi

          echo "Dependency gate passed ✓"

      - name: Show friendly failure message when gate fails
        if: failure()
        run: |
          cat <<'EOF'

          ┌─────────────────────────────────────────────────────────────┐
          │          AI-Lab Dependency Gate – FAILED                    │
          ├─────────────────────────────────────────────────────────────┤
          │ Only packages from the strict allowlist are allowed.        │
          │ New/unknown dependencies require **founder approval**.      │
          │                                                             │
          │ → Create an issue in this repo                              │
          │ → Use label: dependency-request                             │
          │ → Include: package name, desired version, exact use-case    │
          └─────────────────────────────────────────────────────────────┘

          EOF
          exit 1   # optional – keeps job red

  build:
    runs-on: ubuntu-latest
    needs: deps-gate          # crucial: only runs if deps-gate succeeds
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run lint || true
      - run: npm run build